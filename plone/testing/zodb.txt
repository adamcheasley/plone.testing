Zope Object Database layers
===========================

The ZODB layers are found in the module ``plone.testing.zodb``:

    >>> from plone.testing import zodb

For testing, we need a testrunner

    >>> from zope.testing.testrunner import runner

Empty ZODB layer
----------------

The ``EMPTY_ZODB`` layer is used to set up an empty ZODB using
``DemoStorage``.

The storage and database are set up as layer fixtures. The database is exposed
as the resource ``zodbDB``.

A connection is opened for each test and exposed as ``zodbConnection``. The
ZODB root is also exposed, as ``zodbRoot``. A new transaction is begun for
each test. On test tear-down, the transaction is aborted, the connection is
closed, and the two test-specific resources are deleted.

The layer has no bases.

    >>> "%s.%s" % (zodb.EMPTY_ZODB.__module__, zodb.EMPTY_ZODB.__name__,)
    'plone.testing.zodb.EmptyZODB'

    >>> zodb.EMPTY_ZODB.__bases__
    ()

Layer setup creates the database, but not a connection.

    >>> options = runner.get_options([], [])
    >>> setupLayers = {}
    >>> runner.setup_layer(options, zodb.EMPTY_ZODB, setupLayers)
    Set up plone.testing.zodb.EmptyZODB in ... seconds.

    >>> db = zodb.EMPTY_ZODB['zodbDB']
    >>> db.storage
    DemoStorage('MappingStorage', 'MappingStorage')

    >>> zodb.EMPTY_ZODB.get('zodbConnection', None) is None
    True
    >>> zodb.EMPTY_ZODB.get('zodbRoot', None) is None
    True

Let's now simulate a test.

    >>> zodb.EMPTY_ZODB.testSetUp()

The test would then execute. It may use the ZODB root.

    >>> zodb.EMPTY_ZODB['zodbConnection']
    <Connection at ...>
    
    >>> zodb.EMPTY_ZODB['zodbRoot']
    {}

    >>> zodb.EMPTY_ZODB['zodbRoot']['foo'] = 'bar'

On test tear-down, the transaction is aborted and the connection is closed.

    >>> zodb.EMPTY_ZODB.testTearDown()

    >>> zodb.EMPTY_ZODB.get('zodbConnection', None) is None
    True
    
    >>> zodb.EMPTY_ZODB.get('zodbRoot', None) is None
    True
    
The transaction has been rolled back.

    >>> conn = zodb.EMPTY_ZODB['zodbDB'].open()
    >>> conn.root()
    {}
    >>> conn.close()

Layer tear-down closes and deletes the database.

    >>> runner.tear_down_unneeded(options, [], setupLayers)
    Tear down plone.testing.zodb.EmptyZODB in ... seconds.
    
    >>> zodb.EMPTY_ZODB.get('zodbDB', None) is None
    True
